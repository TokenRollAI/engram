# 系统架构总览

## 四层架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        合成层 (Synthesis)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   LLM 摘要   │  │  MCP Server │  │  插件宿主   │              │
│  │ (llama.cpp) │  │  (Stdio/SSE)│  │  (wasmtime) │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
├─────────────────────────────────────────────────────────────────┤
│                        记忆层 (Memory)                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   SQLite (sqlite-vec)                    │    │
│  │  ┌──────────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │    │
│  │  │activity_sess. │  │ traces  │  │summaries│  │entities │  │    │
│  │  └──────────────┘  └─────────┘  └─────────┘  └─────────┘  │    │
│  │  ┌──────────────┐  ┌─────────┐                             │    │
│  │  │session_events │  │ FTS5 索引│                            │    │
│  │  └──────────────┘  └─────────┘                             │    │
│  └─────────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────────┤
│                        认知层 (Cognitive)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  OCR 引擎   │  │  文本嵌入   │  │  视觉嵌入   │              │
│  │ (PaddleOCR) │  │  (MiniLM)   │  │   (CLIP)    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│  ┌─────────────────────────────────────────────────┐            │
│  │            零样本分类器 (语义黑名单)              │            │
│  └─────────────────────────────────────────────────┘            │
├─────────────────────────────────────────────────────────────────┤
│                        感知层 (Sensory)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  屏幕捕获   │  │  窗口监听   │  │  闲置检测   │              │
│  │   (scap)    │  │(active-win) │  │(user-idle)  │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│  ┌─────────────────────────────────────────────────┐            │
│  │              感知哈希去重 (pHash)                │            │
│  └─────────────────────────────────────────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

## 进程架构

```
┌────────────────────────────────────────────────────────────────┐
│                     操作系统                                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                 Engram 主进程 (Tauri)                     │  │
│  │  ┌────────────────┐   ┌──────────────────────────────┐   │  │
│  │  │  前端 (WebView) │   │        Rust 后端             │   │  │
│  │  │                │   │  ┌──────────────────────────┐│   │  │
│  │  │  - 时间线 UI   │◄──┤  │    Engram Daemon         ││   │  │
│  │  │  - 搜索 UI     │   │  │  - 截图循环 (0.5Hz)      ││   │  │
│  │  │  - 设置 UI     │   │  │  - OCR 管道              ││   │  │
│  │  │                │   │  │  - 向量化管道            ││   │  │
│  │  │                │───┤  │  - 数据库管理            ││   │  │
│  │  │                │   │  │  - MCP Server            ││   │  │
│  │  └────────────────┘   │  └──────────────────────────┘│   │  │
│  │                       │  ┌──────────────────────────┐│   │  │
│  │                       │  │   ONNX Runtime Session   ││   │  │
│  │                       │  │  - PaddleOCR 模型        ││   │  │
│  │                       │  │  - MiniLM 嵌入模型       ││   │  │
│  │                       │  └──────────────────────────┘│   │  │
│  │                       └──────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              │ 子进程管理                        │
│                              ▼                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              llama-server (Sidecar 进程)                  │  │
│  │              监听 127.0.0.1:{random_port}                │  │
│  │              加载 Qwen-2.5-7B-Q4_K_M.gguf                │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
```

## 模块边界与职责

### 感知层 (Sensory Layer)
**职责**: 采集原始数据，执行初步过滤

| 模块 | 输入 | 输出 | 触发条件 |
|------|-----|------|---------|
| ScreenCapture | 显示器像素 | RgbaImage | 定时器 (2s) |
| WindowWatcher | 系统事件 | FocusContext | 焦点变化 |
| IdleDetector | HID 事件 | IdleState | 轮询 (1s) |
| FrameDiffer | 当前帧 + 上一帧哈希 | ShouldProcess | 每帧 |

### 认知层 (Cognitive Layer)
**职责**: 将非结构化数据转为结构化知识

| 模块 | 输入 | 输出 | 依赖 |
|------|-----|------|------|
| OcrEngine | RgbaImage | OcrResult (text, boxes) | ort, PaddleOCR |
| TextEmbedder | String | Vec<f32> (384d) | fastembed |
| ImageEmbedder | RgbaImage | Vec<f32> (512d) | ort, CLIP |
| ContentFilter | OcrResult | FilterDecision | NLI 模型 |

### 记忆层 (Memory Layer)
**职责**: 持久化存储，提供检索能力

| 模块 | 接口 | 实现 |
|------|-----|------|
| TraceStore | insert, query_by_time, delete | rusqlite |
| VectorIndex | search_similar | sqlite-vec |
| FullTextSearch | search_text | FTS5 |
| SummaryStore | insert, get_by_range | rusqlite |

### 合成层 (Synthesis Layer)
**职责**: 高级推理与外部交互

| 模块 | 职责 | 依赖 |
|------|-----|------|
| Summarizer | 周期性摘要生成 | llama.cpp HTTP API |
| McpServer | MCP 协议实现 | mcp-sdk |
| PluginHost | WASM 插件执行 | wasmtime |

## 线程模型

```
Main Thread (Tokio Runtime)
├── UI 事件循环
├── IPC Handler (Tauri Commands)
└── MCP Server (异步 TCP/Stdio)

Worker Thread Pool
├── ScreenCapture Worker (专用线程，防止阻塞)
├── OCR Worker (CPU 密集，可并发)
├── Embedding Worker (CPU 密集)
└── DB Writer Worker (I/O 密集，单线程避免锁竞争)

Background Timer
├── 截图定时器 (2s 间隔)
├── 摘要定时器 (15min 间隔)
└── 清理定时器 (每日)
```

## 关键设计决策

### 1. 同步 vs 异步 OCR
**决策**: OCR 在专用线程池中同步执行

**理由**:
- ONNX Runtime 推理是 CPU 密集型，async 不带来优势
- 避免 async 运行时与 ONNX 线程池的复杂交互

### 2. 图像存储格式
**决策**: WebP 有损压缩 (Quality=85)

**理由**:
- 比 PNG 小 5-10 倍
- 比 JPEG 小 25-35%
- 支持 Alpha 通道 (可选)

### 3. 向量维度选择
**决策**: 文本 384d, 图像 512d

**理由**:
- MiniLM 原生 384d，平衡质量与存储
- CLIP ViT-B/32 原生 512d
