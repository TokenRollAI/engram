# 数据流设计

## 主数据流

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Engram 数据流水线                              │
└─────────────────────────────────────────────────────────────────────────┘

    ┌─────────┐
    │  定时器  │ (每 2 秒)
    └────┬────┘
         │
         ▼
┌─────────────────┐    idle?     ┌─────────────┐
│   闲置检测       │─────Yes────►│  跳过本帧    │
│ (IdleDetector)  │              └─────────────┘
└────────┬────────┘
         │ No
         ▼
┌─────────────────┐              ┌─────────────┐
│   屏幕捕获       │─────────────►│  原始帧     │
│ (ScreenCapture) │              │ (RgbaImage) │
└────────┬────────┘              └──────┬──────┘
         │                              │
         │                              ▼
         │                       ┌─────────────┐
         │                       │  下采样至   │
         │                       │  1920x1080  │
         │                       └──────┬──────┘
         │                              │
         ▼                              ▼
┌─────────────────┐              ┌─────────────┐
│  窗口上下文获取   │              │  感知哈希   │
│ (WindowWatcher) │              │   计算      │
└────────┬────────┘              └──────┬──────┘
         │                              │
         │                              ▼
         │                       ┌─────────────┐   similar?
         │                       │  哈希对比    │────Yes────►┌────────────┐
         │                       └──────┬──────┘            │更新上一帧  │
         │                              │ No                │结束时间    │
         │                              ▼                   └────────────┘
         │                       ┌─────────────┐
         │                       │  黑名单检查  │
         │                       │ (规则匹配)   │
         │                       └──────┬──────┘
         │                              │
         │         ┌────────────────────┼────────────────────┐
         │         │                    │                    │
         ▼         ▼                    ▼                    ▼
┌─────────────────────┐          ┌─────────────┐     ┌─────────────────┐
│   构建帧上下文        │          │  JPEG 压缩  │     │  保存 traces    │
│   (FrameContext)    │          │  保存文件    │     │  (ocr_text=NULL)│
└─────────┬───────────┘          └──────┬──────┘     └────────┬────────┘
          │                             │                     │
          │                             │                     ▼
          │                             │            ┌─────────────────────┐
          │                             │            │  [VLM 后台任务启动]  │
          │                             │            │   VlmTask (M3.1)   │
          │                             │            │  (定时扫描，异步)    │
          │                             │            └────────┬───────────┘
          │                             │                     │
          │                             │                     ▼
          │                             │            ┌─────────────────────┐
          │                             │            │  加载截图文件       │
          │                             │            └────────┬───────────┘
          │                             │                     │
          │                             │                     ▼
          │                             │            ┌─────────────────────┐
          │                             │            │  调用 VLM 引擎      │
          │                             │            │  (Ollama/vLLM/等)  │
          │                             │            └────────┬───────────┘
          │                             │                     │
          │                             │                     ▼
          │                             │            ┌─────────────────────┐
          │                             │            │  获得 ScreenDesc    │
          │                             │            │  (summary, text...)│
          │                             │            └────────┬───────────┘
          │                             │                     │
          │                             │                     ▼
          │                             │            ┌─────────────────────┐
          │                             │            │  更新 ocr_text      │
          │                             │            │  写回 traces.vlm_*   │
          │                             │            └────────┬───────────┘
          │                             │                     │
          │                             │                     ▼
          │                             │            ┌─────────────────────┐
          │                             │            │  生成文本嵌入向量   │
          │                             │            │  (MiniLM-384d)     │
          │                             │            └────────┬───────────┘
          │                             │                     │
          └─────────────────────────────┴─────────────────────┘
                                        │
                                        ▼
                               ┌─────────────────────┐
                               │  更新数据库          │
                               │  (trace.ocr_text)   │
                               │  (embedding)        │
                               │  (traces 表)        │
                               │  (activity_sessions)│
                               └─────────────────────┘
```

**数据流说明**:
1. **捕获阶段** - 截图、去重、黑名单检查
2. **存储阶段** - JPEG 压缩保存、痕迹记录插入
3. **后台分析阶段** (VlmTask - M3.1 新增):
   - VlmTask 定时扫描 `ocr_text IS NULL` 的痕迹
   - 加载截图文件并调用 VLM 进行屏幕理解
   - trace 仅更新轻量 `ocr_text` 与 `embedding`，并写入 `is_key_action`
   - VLM 的结构化结论写回 `traces`（`vlm_*` 字段），并增量更新 `activity_sessions.title/description/context_text/entities_json/key_actions_json`

## 帧数据结构

```rust
/// 原始捕获帧
struct CapturedFrame {
    /// 原始像素数据 (RGBA)
    pixels: Vec<u8>,
    /// 物理尺寸
    width: u32,
    height: u32,
    /// 捕获时间戳 (ms)
    timestamp: i64,
}

/// 窗口上下文
struct FocusContext {
    /// 进程名
    app_name: String,
    /// 窗口标题
    window_title: String,
    /// 窗口位置
    bounds: Rect,
    /// 是否全屏
    is_fullscreen: bool,
    /// 进程 ID
    pid: u32,
}

/// OCR 结果
struct OcrResult {
    /// 纯文本 (所有文本块拼接)
    full_text: String,
    /// 详细结果 (含坐标)
    blocks: Vec<TextBlock>,
}

struct TextBlock {
    text: String,
    confidence: f32,
    bbox: Rect,  // [x, y, w, h]
}

/// 最终存储的痕迹记录
struct Trace {
    id: i64,
    timestamp: i64,
    image_path: String,
    context: FocusContext,
    ocr_text: String,
    embedding: Vec<f32>,  // 384 维
    activity_session_id: Option<i64>,
}
```

## 去重算法

```
输入: current_frame, previous_hash
输出: ShouldProcess (bool)

1. 计算当前帧的感知哈希
   curr_hash = blockmean_hash(current_frame)

2. 计算汉明距离
   distance = hamming_distance(curr_hash, previous_hash)

3. 判断是否处理
   if distance < THRESHOLD (默认 5):
       return ShouldSkip  // 相似帧，跳过
   else:
       update previous_hash = curr_hash
       return ShouldProcess
```

## 摘要生成流程

```
┌─────────────┐
│  定时触发    │ (每 15 分钟)
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│  查询时间窗口内的    │
│  所有 traces        │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  聚合 OCR 文本       │
│  按时间排序          │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  构建 LLM Prompt    │
│  (包含时间戳+应用+文本)│
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  调用 llama-server  │
│  HTTP API           │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  解析 JSON 响应      │
│  (摘要+实体+链接)    │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  向量化摘要文本      │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  写入 summaries 表  │
│  更新 entities 表   │
└─────────────────────┘
```

## 搜索流程

```
┌─────────────┐
│  用户输入    │
│  查询词      │
└──────┬──────┘
       │
       ├───────────────────┬──────────────────┐
       │                   │                  │
       ▼                   ▼                  ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  FTS5 全文   │    │  向量化查询  │    │  时间范围   │
│  检索        │    │  词          │    │  过滤       │
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                  │                  │
       ▼                  ▼                  │
┌─────────────┐    ┌─────────────┐          │
│  返回匹配    │    │  余弦相似度  │          │
│  trace IDs  │    │  Top-K 检索  │          │
└──────┬──────┘    └──────┬──────┘          │
       │                  │                  │
       └──────────────────┴──────────────────┘
                          │
                          ▼
                   ┌─────────────┐
                   │  结果融合    │
                   │  (RRF/加权)  │
                   └──────┬──────┘
                          │
                          ▼
                   ┌─────────────┐
                   │  返回 Top N  │
                   │  traces     │
                   └─────────────┘
```

## 数据生命周期

```
时间轴:  ─────────────────────────────────────────────────────►

         │◄─── 热数据 ───►│◄─── 温数据 ───►│◄─── 冷数据 ───►
         │     (0-7d)     │    (7-30d)     │    (30d+)      │
         │                │                │                │
保留内容: │ 截图 + OCR +   │ OCR + 向量 +   │ 摘要 + 实体    │
         │ 向量 + 元数据   │ 元数据          │                │
         │                │                │                │
存储估算: │ ~100KB/帧      │ ~5KB/帧        │ ~1KB/摘要      │
```
